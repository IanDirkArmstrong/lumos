# Lumos v0.3 "Polish" Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add verification tools - test pattern display, real-time gamma curve visualization, and slider tick marks at common gamma values.

**Architecture:** All three features are UI-only changes in `main_window.cpp`. The test pattern opens as a new closable tab (matching the existing Help/About tab pattern). The gamma curve uses ImGui's draw list to render a 256-point line graph inline in the Gamma tab. Tick marks are drawn below the slider using custom draw calls.

**Tech Stack:** ImGui (draw lists for custom rendering), C++20, existing gamma formula from `gamma.cpp`.

---

## Task 1: Add Gamma Curve Visualization

The gamma curve shows the relationship between input brightness (x-axis) and output brightness (y-axis) for the current gamma value. This helps users understand what their gamma setting does.

**Files:**
- Modify: [main_window.cpp](src/ui/main_window.cpp:94-128) (add curve to renderGammaTab)

**Step 1: Add cmath include**

At the top of `main_window.cpp` (after line 7), add:

```cpp
#include <cmath>
```

**Step 2: Add gamma curve rendering to renderGammaTab**

In `main_window.cpp`, in `renderGammaTab()`, after the "Current value display" section (after line 108 `ImGui::Text("Current: %.2f", gamma_slider_);`), add:

```cpp
    // Gamma curve visualization
    ImGui::Spacing();
    ImGui::TextUnformatted("Gamma Curve");

    // Draw area for the curve
    const float curve_height = 100.0f;
    ImVec2 canvas_pos = ImGui::GetCursorScreenPos();
    ImVec2 canvas_size = ImVec2(ImGui::GetContentRegionAvail().x, curve_height);

    // Background
    ImDrawList* draw_list = ImGui::GetWindowDrawList();
    draw_list->AddRectFilled(canvas_pos,
        ImVec2(canvas_pos.x + canvas_size.x, canvas_pos.y + canvas_size.y),
        IM_COL32(30, 30, 30, 255));

    // Draw linear reference line (gamma = 1.0)
    draw_list->AddLine(
        canvas_pos,
        ImVec2(canvas_pos.x + canvas_size.x, canvas_pos.y + canvas_size.y),
        IM_COL32(80, 80, 80, 255), 1.0f);

    // Draw gamma curve
    const double gamma = static_cast<double>(gamma_slider_);
    ImVec2 prev_point = canvas_pos;
    for (int i = 1; i <= 255; ++i) {
        double normalized_in = i / 255.0;
        double normalized_out = std::pow(normalized_in, 1.0 / gamma);

        float x = canvas_pos.x + (i / 255.0f) * canvas_size.x;
        float y = canvas_pos.y + canvas_size.y - static_cast<float>(normalized_out) * canvas_size.y;

        ImVec2 point(x, y);
        draw_list->AddLine(prev_point, point, IM_COL32(100, 200, 100, 255), 2.0f);
        prev_point = point;
    }

    // Border
    draw_list->AddRect(canvas_pos,
        ImVec2(canvas_pos.x + canvas_size.x, canvas_pos.y + canvas_size.y),
        IM_COL32(60, 60, 60, 255));

    // Reserve space for the canvas
    ImGui::Dummy(canvas_size);
```

**Step 3: Build and verify**

Run: `cmake --build build --config Release`
Expected: Build succeeds with no errors

**Step 4: Manual test**

Run the application and verify:
- Green curve appears below the "Current" value display
- Curve updates in real-time as slider moves
- Curve is above diagonal line when gamma > 1.0 (brighter)
- Curve is below diagonal line when gamma < 1.0 (darker)
- Curve matches diagonal when gamma = 1.0

**Step 5: Commit**

```bash
git add src/ui/main_window.cpp
git commit -m "$(cat <<'EOF'
feat: add gamma curve visualization

Shows real-time gamma correction curve in the Gamma tab.
Green curve shows current gamma, gray diagonal shows linear (1.0).
EOF
)"
```

---

## Task 2: Add Slider Tick Marks

Tick marks at common gamma values help users quickly identify standard settings like 1.0 (linear), 2.2 (sRGB standard), and other common values.

**Files:**
- Modify: [main_window.cpp](src/ui/main_window.cpp:99-103) (add tick marks below slider)

**Step 1: Add cstdio include if not present**

At the top of `main_window.cpp`, ensure it includes `<cstdio>` for `std::snprintf`:

```cpp
#include <cstdio>
```

**Step 2: Add tick mark rendering after the slider**

In `main_window.cpp`, in `renderGammaTab()`, after the `ImGui::SliderFloat` call (after line 103), add:

```cpp
    // Draw tick marks at common gamma values
    {
        ImDrawList* draw_list = ImGui::GetWindowDrawList();
        ImVec2 slider_min = ImGui::GetItemRectMin();
        ImVec2 slider_max = ImGui::GetItemRectMax();
        float slider_width = slider_max.x - slider_min.x;

        // Common gamma values to mark
        const float tick_values[] = { 1.0f, 1.8f, 2.2f, 2.5f };
        const float gamma_min = 0.1f;
        const float gamma_max = 9.0f;

        for (float tick_val : tick_values) {
            // Calculate position (slider uses linear mapping)
            float t = (tick_val - gamma_min) / (gamma_max - gamma_min);
            float x = slider_min.x + t * slider_width;
            float y_top = slider_max.y;
            float y_bottom = slider_max.y + 6.0f;

            // Draw tick line
            draw_list->AddLine(
                ImVec2(x, y_top),
                ImVec2(x, y_bottom),
                IM_COL32(150, 150, 150, 255), 1.0f);

            // Draw label
            char label[8];
            std::snprintf(label, sizeof(label), "%.1f", tick_val);
            ImVec2 text_size = ImGui::CalcTextSize(label);
            draw_list->AddText(
                ImVec2(x - text_size.x * 0.5f, y_bottom + 2.0f),
                IM_COL32(120, 120, 120, 255), label);
        }

        // Add spacing to account for tick marks and labels
        ImGui::Dummy(ImVec2(0, 20.0f));
    }
```

**Step 3: Build and verify**

Run: `cmake --build build --config Release`
Expected: Build succeeds with no errors

**Step 4: Manual test**

Run the application and verify:
- Tick marks appear below the slider at 1.0, 1.8, 2.2, 2.5
- Labels are centered below each tick
- Spacing looks balanced

**Step 5: Commit**

```bash
git add src/ui/main_window.cpp
git commit -m "$(cat <<'EOF'
feat: add tick marks at common gamma values

Shows tick marks below slider at 1.0, 1.8, 2.2, and 2.5.
These are common gamma standards (linear, Mac, sRGB, video).
EOF
)"
```

---

## Task 3: Add Test Pattern Tab

A test pattern with alternating black and white stripes helps users calibrate their display by showing whether gamma affects perceived brightness uniformly. This follows the existing tab pattern (Help, About).

**Files:**
- Modify: [main_window.h](src/ui/main_window.h) (add tab visibility flag and render method)
- Modify: [main_window.cpp](src/ui/main_window.cpp) (add tab item and render method)

**Step 1: Add test pattern tab state and method to main_window.h**

In `main_window.h`, add the visibility flag (after line 35 `bool show_about_tab_ = false;`):

```cpp
    bool show_test_pattern_tab_ = false;
```

Add the render method declaration (after line 28 `void renderAboutTab();`):

```cpp
    void renderTestPatternTab();
```

Add a public opener method (after line 22 `void openAbout() { show_about_tab_ = true; }`):

```cpp
    void openTestPattern() { show_test_pattern_tab_ = true; }
```

**Step 2: Add test pattern tab item in render()**

In `main_window.cpp`, in `render()`, after the About tab block (after line 61), add:

```cpp
        // Test Pattern tab (closable)
        if (show_test_pattern_tab_) {
            if (ImGui::BeginTabItem("\xE2\x96\xA6 Pattern", &show_test_pattern_tab_)) {  // ▦ Pattern
                renderTestPatternTab();
                ImGui::EndTabItem();
            }
        }
```

**Step 3: Add menu item to open test pattern**

In `main_window.cpp`, in `renderMenuBar()`, in the Help menu (after line 84 `if (ImGui::MenuItem("About"))`), add:

```cpp
            ImGui::Separator();
            if (ImGui::MenuItem("Test Pattern")) {
                show_test_pattern_tab_ = true;
            }
```

**Step 4: Implement renderTestPatternTab()**

At the end of `main_window.cpp` (before the closing namespace brace), add:

```cpp
void MainWindow::renderTestPatternTab()
{
    ImGui::Spacing();

    ImGui::TextWrapped(
        "This pattern helps calibrate your display. "
        "Adjust gamma until the gray areas appear uniform in brightness.");

    ImGui::Spacing();
    ImGui::Separator();
    ImGui::Spacing();

    // Draw striped test pattern
    const float pattern_height = 180.0f;
    ImVec2 canvas_pos = ImGui::GetCursorScreenPos();
    ImVec2 canvas_size = ImVec2(ImGui::GetContentRegionAvail().x, pattern_height);

    ImDrawList* draw_list = ImGui::GetWindowDrawList();

    // Number of stripe pairs
    const int num_stripes = 16;
    const float stripe_width = canvas_size.x / num_stripes;

    for (int i = 0; i < num_stripes; ++i) {
        float x = canvas_pos.x + i * stripe_width;
        ImU32 color = (i % 2 == 0) ? IM_COL32(0, 0, 0, 255) : IM_COL32(255, 255, 255, 255);
        draw_list->AddRectFilled(
            ImVec2(x, canvas_pos.y),
            ImVec2(x + stripe_width, canvas_pos.y + canvas_size.y),
            color);
    }

    // Border
    draw_list->AddRect(canvas_pos,
        ImVec2(canvas_pos.x + canvas_size.x, canvas_pos.y + canvas_size.y),
        IM_COL32(100, 100, 100, 255));

    ImGui::Dummy(canvas_size);

    ImGui::Spacing();
    ImGui::TextDisabled("At correct gamma, alternating stripes should appear evenly bright.");
}
```

**Step 5: Build and verify**

Run: `cmake --build build --config Release`
Expected: Build succeeds with no errors

**Step 6: Manual test**

Run the application and verify:
- Help menu has "Test Pattern" item
- Clicking it opens a new "▦ Pattern" tab
- Tab shows black/white stripes
- Tab is closable (X button works)

**Step 7: Commit**

```bash
git add src/ui/main_window.h src/ui/main_window.cpp
git commit -m "$(cat <<'EOF'
feat: add test pattern tab for display calibration

Adds closable "Pattern" tab showing alternating black/white stripes.
Accessible via Help menu. Helps users verify gamma calibration.
EOF
)"
```

---

## Task 4: Update Version and Help Tab

**Files:**
- Modify: [CMakeLists.txt](CMakeLists.txt:2) (version bump)
- Modify: [main_window.cpp](src/ui/main_window.cpp:180) (version string in renderAboutTab)
- Modify: [main_window.cpp](src/ui/main_window.cpp:130-174) (add v0.3 features to renderHelpTab)

**Step 1: Update version in CMakeLists.txt**

Change line 2 from:
```cmake
project(lumos VERSION 0.2.0 LANGUAGES CXX)
```

To:
```cmake
project(lumos VERSION 0.3.0 LANGUAGES CXX)
```

**Step 2: Update version in renderAboutTab()**

In `main_window.cpp`, in `renderAboutTab()`, change line 180 from:
```cpp
    ImGui::TextUnformatted("Lumos v0.2.0");
```

To:
```cpp
    ImGui::TextUnformatted("Lumos v0.3.0");
```

**Step 3: Update renderHelpTab() to mention new features**

In `main_window.cpp`, in `renderHelpTab()`, after the "Command Line" section (after line 173), add:

```cpp
    ImGui::Spacing();
    ImGui::Separator();
    ImGui::Spacing();

    ImGui::TextUnformatted("Visualization Tools");
    ImGui::Spacing();
    ImGui::BulletText("Gamma Curve: Real-time visualization of gamma correction");
    ImGui::BulletText("Tick Marks: Common gamma values marked on slider");
    ImGui::BulletText("Test Pattern: B&W stripes for calibration (Help menu)");
```

**Step 4: Build and verify**

Run: `cmake --build build --config Release`
Expected: Build succeeds with no errors

**Step 5: Manual test**

Run the application and verify:
- About tab shows "Lumos v0.3.0"
- Help tab has "Visualization Tools" section

**Step 6: Commit**

```bash
git add CMakeLists.txt src/ui/main_window.cpp
git commit -m "$(cat <<'EOF'
chore: bump version to v0.3.0

Updates version string and help documentation for new features.
EOF
)"
```

---

## Task 5: Final Integration Test

**Files:** None (testing only)

**Step 1: Full rebuild**

```bash
rm -rf build && cmake -B build && cmake --build build --config Release
```

Expected: Clean build with no warnings

**Step 2: Manual test checklist**

Run the application and verify all v0.3 features:

- [ ] Gamma curve displays below "Current" value in Gamma tab
- [ ] Curve updates in real-time when slider moves
- [ ] Curve is green, reference line is gray
- [ ] Tick marks appear below slider at 1.0, 1.8, 2.2, 2.5
- [ ] Labels are readable and centered
- [ ] Help menu has "Test Pattern" item
- [ ] Test pattern tab opens with stripes
- [ ] Test pattern shows clear black/white alternating stripes
- [ ] Test pattern tab is closable
- [ ] About tab shows v0.3.0
- [ ] Help tab mentions new visualization features
- [ ] All existing features still work (hotkeys, reset, minimize to tray, tabs)

**Step 3: Create release commit**

```bash
git add -A
git status  # Verify only expected files
git commit -m "$(cat <<'EOF'
release: v0.3.0 "Polish" - verification tools

New features:
- Real-time gamma curve visualization
- Tick marks at common gamma values (1.0, 1.8, 2.2, 2.5)
- Test pattern tab for display calibration
EOF
)"
```

---

## Summary

| Task | Description | Files Changed |
|------|-------------|---------------|
| 1 | Gamma curve visualization | main_window.cpp |
| 2 | Slider tick marks | main_window.cpp |
| 3 | Test pattern tab | main_window.h, main_window.cpp |
| 4 | Version bump and docs | CMakeLists.txt, main_window.cpp |
| 5 | Final integration test | (testing only) |

Total: ~120 lines of new code in main_window.cpp/h.
